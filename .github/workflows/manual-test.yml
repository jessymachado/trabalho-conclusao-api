name: Disparo Manual de Testes

on:
  workflow_dispatch:
    inputs:
      tipo_teste:
        description: Qual teste deseja executar?
        required: true
        default: todos
        type: choice
        options:
          - todos
          - rest-controller
          - rest-external
          - graphql

jobs:
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Criar .env
        run: |
          echo "BASE_URL_REST=${{ secrets.BASE_URL_REST }}" >> .env
          echo "BASE_URL_GRAPHQL=${{ secrets.BASE_URL_GRAPHQL }}" >> .env

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Rodar testes selecionados
        run: |
          set -e
          TIPO="${{ github.event.inputs.tipo_teste }}"
          
          if [ "$TIPO" = "rest-controller" ] || [ "$TIPO" = "todos" ]; then
            echo "Rodando testes REST controller..."
            npm run test-rest-controller
          fi

          if [ "$TIPO" = "rest-external" ] || [ "$TIPO" = "todos" ]; then
            echo "Subindo API REST..."
            npm run start-rest &
            sleep 5
            echo "Rodando testes REST external..."
            npm run test-rest-external
          fi

          if [ "$TIPO" = "graphql" ] || [ "$TIPO" = "todos" ]; then
            echo "Subindo API GraphQL..."
            npm run start-graphql &
            sleep 5
            echo "Rodando testes GraphQL external..."
            npm run test-graphql-external
          fi
